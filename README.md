# Gatekeeper: Telegram-бот для удаления спама

Ссылка: https://t.me/tw_antispam_mini_bot

## Введение

Этот бот предназначен для автоматического определения и удаления спама на основе регулярных выражений в группах технической тематики. Он позволяет администраторам регистрировать чаты, в которых будет удаляться спам, а логи удаленного спама будут пересылаться в диалог с ботом.

Также можно разрешить команду `/ban` для запуска голосования прямо в чате за удаление сообщений.

Помимо этого, бот позволяет включать или выключать автоматическое удаление статусов. Удаляются все статусные сообщения — о вступлении нового пользователя, выходе из чата, закреплении сообщения и т.д.

Создан с помощью библиотеки `python-telegram-bot`.

## Критерии спама

Бот автоматически удаляет сообщения и банит отправителей при наличии одного из следующих признаков:

1. Присутствуют распространенные спам-слова и фразы. Полный перечень паттернов см. [is_spam_message.py](./is_spam_message.py).
1. Сообщение содержит два и более слов, состоящих из сочетания кириллического и любого не-кириллического алфавита.
1. В сообщении есть 12 и более эмодзи.
1. Некоторые дополнительные признаки спама, указанные в коде функции `check_automatically` в основном файле [antispam-mini.py](./antispam-mini.py).

При бане и удалении фиксируются критерии, на основании которых бот удалил сообщение:

![example](./assets/example.png)

## Как начать работу

1. Добавьте бота в нужный чат и сделайте его администратором. Выдайте боту права на удаление сообщений.
1. Начните диалог с ботом, отправив команду `/start`.
1. Используйте команду `/register <chat_id>` для регистрации чата.

Удаление сообщений по команде `/ban` и автоматическое удаление статусов отключены. Если вам нужна эти возможности, включите каждую из них отдельно, как показано ниже.

### Как работает регистрация

Регистрация необходима для любых действий бота в каком-либо чате. Только администраторы чата могут зарегистрировать его с помощью команды `/register`. При отмене регистрации чата с помощью команды `/unregister` все настройки для этого чата удаляются из базы данных.

Чтобы бот удалял сообщения в чате, хотя бы один администратор должен иметь активную регистрацию в этом чате. Бот отправляет удаленные спам-сообщения из чата тем администраторам, которые зарегистрировали чат. Это позволяет администраторам просматривать удаленные сообщения и контролировать работу бота.

Нельзя зарегистрировать чат и в то же время отказаться от пересылки удаленных сообщений.

## Список команд

Все команды бота кроме `/ban` доступны только в личной переписке с ботом. Использование команд в группах запрещено для обеспечения безопасности и предотвращения несанкционированного доступа.

Чтобы получить идентификатор чата для регистрации, используйте один из сторонних ботов, например `@username_to_id_bot` или `@getmy_idbot`. В дальнейшем идентификаторы ваших зарегистрированных чатов можно получить с помощью команды `/list`.

| Команда | Описание |
|---------|----------|
| /start | Начать работу с ботом |
| /register <chat_id> | Зарегистрировать чат |
| /unregister <chat_id> | Отменить регистрацию чата |
| /list | Показать список зарегистрированных чатов |
| /allow_manual <chat_id> | Разрешить использование команды /ban в чате |
| /cancel_manual <chat_id> | Запретить использование команды /ban в чате |
| /ban | Запустить голосование среди участников чата за удаление сообщения |
| /delete_statuses <chat_id> | Включить автоматическое удаление статусов |
| /allow_statuses <chat_id> | Отключить автоматическое удаление статусов |
| /help | Показать справку по командам |

### Команда бана

Бот поддерживает команду `/ban` для удаления сообщений и бана пользователей:

1. Сначала необходимо разрешить ручной бан для чата, используя команду `/allow_manual <chat_id>` в личной переписке с ботом.
1. Чтобы запретить ручной бан для чата, используйте команду `/cancel_manual <chat_id>` в личной переписке с ботом.
1. Ответьте на сообщение командой `/ban`.
1. Бот создаст сообщение с кнопками "Подтвердить" и "Отменить" в ответ на оригинальное сообщение.
1. Для выполнения действия требуется 3 голоса (включая инициатора).
   При подтверждении сообщение удаляется, а пользователь получит бан.
   При отмене никаких действий не совершается.
1. После завершения голосования сообщение бота и команда `/ban` удаляются.
1. Нельзя начать новое голосование для сообщения, если для него уже идет активное голосование.

### Удаление статусов

* Удаление статусов: После регистрации чата администратор может включить автоматическое удаление статусов с помощью команды `/delete_statuses`. По умолчанию эта функция неактивна. Когда эта функция активна, бот будет автоматически удалять все статусные сообщения в чате. Статусы — это автоматические сообщения о входе или выходе участников, изменении названия группы, закреплении сообщения и т.д.

* Отключение удаления статусов: Администратор может в любой момент отключить автоматическое удаление статусов в чате с помощью команды `/allow_statuses`.
